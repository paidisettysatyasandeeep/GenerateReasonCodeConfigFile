sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/HBox","sap/m/VBox","sap/m/Input","sap/m/TextArea","sap/m/Label","sap/m/Button","sap/m/MessageToast"],function(e,t,o,r,i,n,s,a,l){"use strict";return e.extend("downtimeconf.controller.UploadScreen",{CSV_COLUMNS:["SITE","TIME_ELEMENT","REASON_CODE1","REASON_CODE2","REASON_CODE3","REASON_CODE4","REASON_CODE5","REASON_CODE6","REASON_CODE7","REASON_CODE8","REASON_CODE9","SEQUENCE","MARK_FOR_DELETION","DESCRIPTION_EN","DESCRIPTION_FR","DESCRIPTION_DE"],onInit:function(){var e=new t({sites:[{key:"6500",text:"6500"},{key:"6600",text:"6600"}],selectedSite:"",timeElement:"",reasonCode1:"",locked:false,rows:[],rowCount:0});e.setSizeLimit(1e4);this.getView().setModel(e);this._oModel=e;this._oDynamicRows=this.byId("dynamicRows")},_updateRowCount:function(){var e=this._oModel.getProperty("/rows")||[];this._oModel.setProperty("/rowCount",e.length)},onConfirmInitialRow:function(){var e=this._oModel;var t=e.getProperty("/selectedSite");var o=e.getProperty("/timeElement");var r=e.getProperty("/reasonCode1").toUpperCase();if(!t||String(t).trim()===""){l.show("Please select Site before confirming.");return}if(!o||String(o).trim()===""){l.show("Please select Time Element before confirming.");return}if(!r||String(r).trim()===""){l.show("Please enter REASON_CODE1 before confirming.");return}var i=e.getProperty("/rows")||[];var n=i.some(function(e){return e.site===t&&e.time===o&&e.reason1===r.toUpperCase()&&!e.reason2&&!e.reason3});if(!n){var s=this.getDescriptionFromCodes(r,"","");i.unshift({site:t,time:o,reason1:r,reason2:"",reason3:"",description:s});e.setProperty("/rows",i);this._updateRowCount()}else{l.show("Initial row already exists for these values.")}e.setProperty("/locked",true);this.getView().byId("clearButton").setEnabled(true);this.getView().byId("downloadButton").setEnabled(true);this.getView().byId("clearAllButton").setEnabled(true);l.show("Confirmed. Site, Time Element and REASON_CODE1 are locked.")},onAddReasonRow:function(){if(!this._oModel.getProperty("/locked")){l.show("Please confirm the initial values using OK before adding reason rows.");return}var e=new i({width:"220px",placeholder:"Enter REASON_CODE2"});var t=new n({width:"480px",rows:5,placeholder:"Enter REASON_CODE3 values, comma-separated"});var d=new a({text:"Save Row(s)"});d.attachPress(function(){if(!d.getEnabled()){return}d.setEnabled(false);try{this._onSaveRow(e,t)}finally{setTimeout(function(){d.setEnabled(true)},200)}}.bind(this));var m=new a({icon:"sap-icon://decline",press:function(){if(!this._oDynamicRows){this._oDynamicRows=this.byId("dynamicRows")}this._oDynamicRows.removeItem(u)}.bind(this)});var u=new o({items:[new r({items:[new s({text:"REASON_CODE2"}),e]}),new r({items:[new s({text:"REASON_CODE3 (comma-separated)"}),t]}),new r({items:[new s({text:"Action"}),d]}),new r({items:[new s({text:""}),m]})],justifyContent:"SpaceBetween",width:"100%"});if(!this._oDynamicRows){this._oDynamicRows=this.byId("dynamicRows")}this._oDynamicRows.addItem(u)},onClearInitialRow:function(){this._oModel.setProperty("/locked",false);this._oModel.setProperty("/reasonCode1","");this._oModel.setProperty("/selectedSite","");this._oModel.setProperty("/timeElement","");this.getView().byId("clearButton").setEnabled(false)},_onSaveRow:function(e,t){var o=this._oModel;if(!o.getProperty("/locked")){l.show("Please confirm the initial row first.");return}var r=o.getProperty("/selectedSite");var i=o.getProperty("/timeElement");var n=o.getProperty("/reasonCode1");var s=e.getValue&&e.getValue().trim()||"";if(!s){l.show("Please enter REASON_CODE2 before saving.");return}var a=t.getValue&&t.getValue()||"";var d=a.split(/\s*,\s*/).map(function(e){return String(e).trim()}).filter(Boolean);var m=o.getProperty("/rows")||[];var u=new Set(m.map(function(e){return[e.site,e.time,e.reason1,e.reason2,e.reason3].join("|")}));var c=0;var w=[r,i,n,s,""].join("|");if(!u.has(w)){m.push({site:r,time:i,reason1:n.toUpperCase(),reason2:s,reason3:"",description:n.toUpperCase()+"_"+s});u.add(w);c++}d.forEach(function(e){var t=[r,i,n,s,e].join("|");if(!u.has(t)){var o=this.getDescriptionFromCodes(n,s,e);m.push({site:r,time:i,reason1:n.toUpperCase(),reason2:s,reason3:e,description:o});u.add(t);c++}}.bind(this));if(c===0){l.show("No new rows added (all entries already exist).")}else{o.setProperty("/rows",m);this._updateRowCount();l.show(c+" row(s) added.")}this._removeContainingHBox(e)},_removeContainingHBox:function(e){if(!this._oDynamicRows){this._oDynamicRows=this.byId("dynamicRows")}var t=this._oDynamicRows.getItems();for(var o=0;o<t.length;o++){if(t[o].findAggregatedObjects(true).indexOf(e)!==-1){this._oDynamicRows.removeItem(t[o]);break}}},getDescriptionFromCodes:function(e,t,o){if((!t||String(t).trim()==="")&&(!o||String(o).trim()==="")){return e}if(!o){return""}return o},onDeleteRow:function(e){var t=e.getSource();var o=t.getParent();while(o&&!(o.isA&&o.isA("sap.m.ColumnListItem"))){o=o.getParent()}if(!o){jQuery.sap.log.warning("Could not find ColumnListItem ancestor for delete button.");return}var r=o;var i=this.byId("dataTable");if(!i){jQuery.sap.log.warning("dataTable not found when deleting row.");return}var n=i.indexOfItem(r);if(n===-1){jQuery.sap.log.warning("Could not determine index of the list item to delete.");return}var s=this._oModel.getProperty("/rows")||[];s.splice(n,1);this._oModel.setProperty("/rows",s);this._updateRowCount();if(s.length===0){this._oModel.setProperty("/locked",false);var a=this.getView().byId("clearButton");if(a){a.setEnabled(false)}var l=this.getView().byId("downloadButton");if(l){l.setEnabled(false)}var d=this.getView().byId("clearAllButton");if(d){d.setEnabled(false)}}},onClearAll:function(){this._oModel.setProperty("/locked",false);this.getView().byId("clearButton").setEnabled(false);this._oModel.setProperty("/rows",[]);this._updateRowCount();if(this._oDynamicRows){this._oDynamicRows.removeAllItems()}l.show("Data Cleared");this.getView().byId("downloadButton").setEnabled(false);this.getView().byId("clearAllButton").setEnabled(false)},mapRowToCsv:function(e){var t=this.CSV_COLUMNS;var o={SITE:e.site||"",TIME_ELEMENT:e.time||"",REASON_CODE1:e.reason1?String(e.reason1).toUpperCase():"",REASON_CODE2:e.reason2||"",REASON_CODE3:e.reason3||"",REASON_CODE4:"",REASON_CODE5:"",REASON_CODE6:"",REASON_CODE7:"",REASON_CODE8:"",REASON_CODE9:"",SEQUENCE:"",MARK_FOR_DELETION:"",DESCRIPTION_EN:e.description||"",DESCRIPTION_FR:"",DESCRIPTION_DE:""};return t.map(function(e){return o[e]!==undefined?o[e]:""})},getFileName(e){const t=this.getView();const o=t.byId("timeElement");let r=o?.getSelectedItem()?.getText()||this._oModel.getProperty("/timeElement")||"";const i=r.toString().trim().split(/\s+/).map(e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()).join(" ");const n=new Date;const s=[String(n.getMonth()+1).padStart(2,"0"),String(n.getDate()).padStart(2,"0"),n.getFullYear()].join("");const a=`${i} (${e.toUpperCase()}) ${s}`;return a},onDownloadCSV:function(){var e=this._oModel.getProperty("/rows")||[];if(!e||e.length===0){l.show("No rows to export");return}var t=this._oModel.getProperty("/reasonCode1");if(!t||String(t).trim()===""){l.show("Please provide REASON_CODE1 before exporting.");return}var o=this.getFileName(t.trim());var r=this.CSV_COLUMNS;function i(e){if(e===undefined||e===null)return"";var t=String(e);if(t.indexOf(",")!==-1||t.indexOf('"')!==-1||t.indexOf("\n")!==-1){t='"'+t.replace(/"/g,'""')+'"'}return t}var n=r.join(",")+"\r\n";for(var s=0;s<e.length;s++){var a=e[s];var d=this.mapRowToCsv(a);var m=d.map(i);n+=m.join(",")+"\r\n"}var u=new Blob(["\ufeff",n],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob){navigator.msSaveBlob(u,o)}else{var c=document.createElement("a");if(c.download!==undefined){var w=URL.createObjectURL(u);c.setAttribute("href",w);c.setAttribute("download",o);c.style.visibility="hidden";document.body.appendChild(c);c.click();document.body.removeChild(c)}}}})});
//# sourceMappingURL=UploadScreen.controller.js.map